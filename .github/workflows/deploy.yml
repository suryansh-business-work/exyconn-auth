# =============================================================================
# Exyconn Auth Deployment
# Services: UI (Port: 4001) | Server (Port: 4002)
# Domain: auth.exyconn.com
# =============================================================================

name: üöÄ Deploy Auth

on:
  push:
    branches: [main]
    paths: ['ui/**', 'server/**', 'docker-compose.yml', '.github/workflows/deploy.yml']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì¢ Slack - Started
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "attachments": [{"color": "#0066FF", "blocks": [
              {"type": "header", "text": {"type": "plain_text", "text": "üöÄ Auth - Deployment Started", "emoji": true}},
              {"type": "section", "fields": [
                {"type": "mrkdwn", "text": "*üì¶ Service:*\nExyconn Auth"},
                {"type": "mrkdwn", "text": "*üîå Ports:*\n4001 (UI) | 4002 (Server)"},
                {"type": "mrkdwn", "text": "*üë§ By:*\n${{ github.actor }}"},
                {"type": "mrkdwn", "text": "*üè∑Ô∏è Build:*\n#${{ github.run_number }}"}
              ]}
            ]}]
          }' ${{ secrets.SLACK_WEBHOOK }}

      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üèóÔ∏è Build & Push UI
        uses: docker/build-push-action@v5
        with:
          context: ./ui
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/exyconn-auth-ui:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üèóÔ∏è Build & Push Server
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/exyconn-auth-server:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üöÄ Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            
            # Create network if not exists
            docker network create exyconn-network 2>/dev/null || true
            
            # Kill any process using ports
            sudo fuser -k 4001/tcp 2>/dev/null || true
            sudo fuser -k 4002/tcp 2>/dev/null || true
            
            # ===== Deploy Server =====
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/exyconn-auth-server:latest
            docker stop exyconn-auth-server 2>/dev/null || true
            docker rm -f exyconn-auth-server 2>/dev/null || true
            
            docker ps -q --filter "publish=4002" | xargs -r docker stop || true
            docker ps -aq --filter "publish=4002" | xargs -r docker rm -f || true
            
            docker run -d \
              --name exyconn-auth-server \
              --restart unless-stopped \
              --network exyconn-network \
              -p 4002:4002 \
              -e NODE_ENV=production \
              -e PORT=4002 \
              ${{ secrets.DOCKERHUB_USERNAME }}/exyconn-auth-server:latest
            
            # ===== Deploy UI =====
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/exyconn-auth-ui:latest
            docker stop exyconn-auth-ui 2>/dev/null || true
            docker rm -f exyconn-auth-ui 2>/dev/null || true
            
            docker ps -q --filter "publish=4001" | xargs -r docker stop || true
            docker ps -aq --filter "publish=4001" | xargs -r docker rm -f || true
            
            docker run -d \
              --name exyconn-auth-ui \
              --restart unless-stopped \
              --network exyconn-network \
              -p 4001:80 \
              -e NODE_ENV=production \
              -e VITE_API_URL=https://auth-api.exyconn.com \
              ${{ secrets.DOCKERHUB_USERNAME }}/exyconn-auth-ui:latest
            
            sleep 5
            echo "=== Running Containers ==="
            docker ps --filter "name=exyconn-auth"
            curl -sf http://localhost:4002/health || echo "Server starting..."
            curl -sf http://localhost:4001/ | head -3 || echo "UI starting..."

      - name: ‚úÖ Slack - Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "attachments": [{"color": "#00C853", "blocks": [
              {"type": "header", "text": {"type": "plain_text", "text": "‚úÖ Auth - Deployed!", "emoji": true}},
              {"type": "section", "fields": [
                {"type": "mrkdwn", "text": "*üåê UI:*\nhttps://auth.exyconn.com"},
                {"type": "mrkdwn", "text": "*üîå Ports:*\n4001 | 4002"}
              ]},
              {"type": "actions", "elements": [
                {"type": "button", "text": {"type": "plain_text", "text": "üåê Open Auth"}, "url": "https://auth.exyconn.com", "style": "primary"}
              ]}
            ]}]
          }' ${{ secrets.SLACK_WEBHOOK }}

      - name: ‚ùå Slack - Failed
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "attachments": [{"color": "#FF1744", "blocks": [
              {"type": "header", "text": {"type": "plain_text", "text": "‚ùå Auth - FAILED!", "emoji": true}},
              {"type": "actions", "elements": [
                {"type": "button", "text": {"type": "plain_text", "text": "üìã Logs"}, "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "style": "danger"}
              ]}
            ]}]
          }' ${{ secrets.SLACK_WEBHOOK }}
